<!DOCTYPE html>
<html>

<head>
    <title> Filter data on map with Circle | CARTO</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet">
    <!-- Include Leaflet Draw plugin -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.13/leaflet.draw.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.13/leaflet.draw.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5.1.6/turf.min.js"></script>

    <!-- Include CARTO.js -->
    <script src="../../../dist/public/carto.js"></script>
    <link href="../style.css" rel="stylesheet">

</head>

<body>
    <!-- map element -->
    <div id="map"></div>

    <!-- Description -->
    <aside class="toolbox">
        <div class="box">
            <header>
                <h1>Filter data based on a Circle</h1>
            </header>
            <div class="widget category">
                <!-- To be updated with Category & Circle filter -->
            </div>
            <div class="widget formula">
                <!-- To be updated with Formula & Circle filter -->
            </div>
            <div class="widget histogram">
                <!-- To be updated with Histogram & Circle filter -->
            </div>
            <footer class="js-footer"></footer>
        </div>

    </aside>

    <script>
        // set map with initial zoom and coodinates view
        const map = L.map('map').setView([40, -80], 7);

        // disable scroll wheel zoom
        map.scrollWheelZoom.disable();

        // add basemaps to map
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

        // layer to draw circles
        let drawnItems = L.featureGroup().addTo(map);

        // set CARTO client
        // const client = new carto.Client({
        //         apiKey: 'default_public',
        //         username: 'cartojs-test'
        //     });

        const client = new carto.Client({
            apiKey: 'cb87fdd365de6e78eda5734c3427224ec4bc9033',
            username: 'cdb',
            serverUrl: 'http://cdb.localhost.lan:8181'
        });

        // set SQL query to create the grid of hexagons
        const source = new carto.source.SQL(`
                SELECT * FROM ne_10m_populated_places_simple
            `);

        // define styles of layer.
        const style = new carto.style.CartoCSS(`
                #layer {
                        marker-fill: red;
                    }
            `);

        // set the CARTO layer using the source and style defines previously
        const layer = new carto.layer.Layer(source, style, {
            featureClickColumns: ['name', 'adm0name', 'adm1name', 'pop_max']
        });

        // add CARTO layer to the client
        client.addLayer(layer);
        client.getLeafletLayer().addTo(map);

        layer.on('featureClicked', featureEvent => {
            console.log(featureEvent.data);
        });

        // Category dataview
        const categoryDataview = new carto.dataview.Category(source, 'adm1name', {
            limit: 4,
            operation: carto.operation.SUM,
            operationColumn: 'pop_max'
        });
        categoryDataview.on('dataChanged', renderWidgetCategory);
        client.addDataview(categoryDataview);

        // Formula dataview
        const formulaDataview = new carto.dataview.Formula(source, 'pop_max', {
            operation: carto.operation.COUNT,
        });
        formulaDataview.on('dataChanged', renderWidgetFormula);
        client.addDataview(formulaDataview);

        // Histogram dataview
        const histogramDataview = new carto.dataview.Histogram(source, 'pop_max', { bins: 10 });
        histogramDataview.on('dataChanged', renderWidgetHistogram);
        client.addDataview(histogramDataview);


        // Circle filter, applied to Category dataview
        const circleFilter = new carto.filter.Circle();
        circleFilter.setCircle({
            lat: 0,
            lng: 0,
            radius: 0
        }); // initial filter

        debug();

        function debug() {
            const Y = 42.373976901906055;
            const X = -4.76428185675705;
            const R = 221701.68161184734;

            circleFilter.setCircle({
                lat: Y,
                lng: X,
                radius: R
            });

            // 1. Leaflet circle
            var circle = L.circle([Y, X], {
                color: "red",
                fillColor: "#f03",
                fillOpacity: 0,
                radius: R
            }).addTo(map);

            // 2. Turf circle
            // var turfCircle = turf.circle([X, Y], R / 1000.0, {
            //     steps: 12,
            //     units: 'kilometers'
            // });
            // L.geoJSON(turfCircle, {
            //     style: {
            //         color: 'green',
            //         fillOpacity: 0
            //     }
            // }).addTo(map);

            // 3. Turf buffer
            var buffered = turf.buffer(turf.point([X, Y]), R / 1000.0, {
                units: 'kilometers'
            });
            L.geoJSON(buffered, {
                style: {
                    color: 'purple',
                    fillOpacity: 0
                }
            }).addTo(map);
        };

        // Apply circleFilter to datasviews
        categoryDataview.addFilter(circleFilter);
        formulaDataview.addFilter(circleFilter);
        histogramDataview.addFilter(circleFilter);

        // Display Category dataview
        function renderWidgetCategory(data) {
            const categories = data.categories.map(category => `
            <li>
                <h3>${category.name}</h3>
                <p class="open-sans">${parseInt(category.value)} <small>inhabitants</small></p>
            </li>
            `).join('');
            const content = `<ul>${categories}</ul>`;

            document.querySelector('.widget.category').innerHTML = content;
        }

        // Display Formnula dataview
        function renderWidgetFormula(data) {
            const content = `<h2 class="h2">${data.result} <small>cities</small></h2>`;
            document.querySelector('.widget.formula').innerHTML = content;
        }

        // Display histogram dataview
        function renderWidgetHistogram(data) {
            let histogram = '<ul class="open-sans">';
            data.bins.forEach(bin => {
                const line = '<li>' + bin.start + ' to ' + bin.end + ' has ' + bin.freq + ' cities</li>';
                histogram += line;
            });
            histogram += "</ul>";
            document.querySelector('.widget.histogram').innerHTML = histogram;
        }

        // control to add a circle and modify filter
        let drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                polyline: false,
                line: false,
                marker: false,
                rectangle: false,
                circle: {
                    shapeOptions: {
                        color: 'red',
                        weight: 0.1,
                        opacity: 0.5
                    }
                },
                circlemarker: false,
            },
            edit: false
        });

        map.addControl(drawControl);

        // get radius and center & apply to Circle filter
        map.on(L.Draw.Event.CREATED, function (e, d) {
            let circle = e.layer;

            // get circle data
            let radius = circle.getRadius();
            let centerLat = circle.getLatLng().lat;
            let centerLng = circle.getLatLng().lng;

            drawnItems.clearLayers();
            drawnItems.addLayer(circle); // add geometric circle

            // Add turf buffer
            var buffered = turf.buffer(turf.point([centerLng, centerLat]), radius / 1000.0, {
                units: 'kilometers'
            });
            L.geoJSON(buffered).addTo(drawnItems);

            const circleData = {
                lat: centerLat,
                lng: centerLng,
                radius: radius
            };
            console.log(circleData);

            circleFilter.setCircle(circleData); // updated filter
        });

    </script>
</body>

</html>
