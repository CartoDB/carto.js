<!DOCTYPE html>
<html>
  <head>
    <title>Layer error handling | Carto</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet">
    <!-- Include Carto.js -->
    <script src="../../../dist/public/carto.uncompressed.js"></script>
    <style>
      body { margin: 0; padding: 0; }
      #map { position: absolute; height: 100%; width: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      function logCartoError (prefix, cartoError) {
        if (cartoError.name !== 'CartoError') {
          throw new Error('This is suposed to be a CartoError!')
        }
        console.log(prefix, '\n', cartoError.name, '\n', cartoError.errorCode, '\n', cartoError.message);
      }

      const map = L.map('map').setView([40, 0], 5);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18
      }).addTo(map);

      const client = new carto.Client({
        apiKey: 'f8428dda3b56a9f421dd408a86a283b0efcd1a6d',
        username: 'ivan',
        serverUrl: 'http://ivan.localhost.lan:8181'
      });

      const spainCitiesSource = new carto.source.SQL(`
        SELECT *
          FROM ne_10m_populated_places_simple
          WHERE adm0name = \'Russia\'
      `);
      spainCitiesSource.on(carto.events.ERROR, function (error) {
        logCartoError('SOURCE ERROR', error);
      });

      const spainCitiesStyle = new carto.style.CartoCSS(`
        #layer {
          marker-width: 64;
          marker-fill: "#FABADA";
          marker-line-color: #FFFFFF;
        }
      `);
      spainCitiesStyle.on(carto.events.ERROR, function (error) {
        logCartoError('STYLE ERROR', error);
      });

      const spainCitiesLayer = new carto.layer.Layer(spainCitiesSource, spainCitiesStyle, {
        featureClickColumns: ['adm0name']
      });
      spainCitiesLayer.on(carto.events.ERROR, function (error) {
        logCartoError('LAYER ON ERROR', error);
      });
      spainCitiesLayer.on(carto.layer.events.TILE_ERROR, function (error) {
        logCartoError('LAYER TILE ERROR', error);
      });

      const europeCountriesSource = new carto.source.SQL(`
        SELECT *
          FROM ne_10m_populated_places_simple
          WHERE adm0name = \'United States of America\'
      `);      
      const europeCountriesStyle = new carto.style.CartoCSS(`
        #layer {
          marker-width: 64;
          marker-fill: "#C0FFEE";
          marker-line-color: #FFFFFF;
        }
      `);
      const europeCountriesLayer = new carto.layer.Layer(europeCountriesSource, europeCountriesStyle);

      client.addLayers([europeCountriesLayer, spainCitiesLayer])
        .catch(function (error) {
          logCartoError('ADD LAYERS', error)
        });
      client.getLeafletLayer().addTo(map);
      client.on(carto.events.ERROR, function (error) {
        logCartoError('CLIENT ERROR', error);
      });

      var layerActions = {
        provokeStyleError: function () {
          spainCitiesLayer.setStyle(new carto.style.CartoCSS(`
            #layer {
              marker-fill: "wrong-value";
              marker-line-color: #FFFFFF;
            }`
          )).catch(function (error) {
            logCartoError('', error);
          });
        },
        provokeError: function () {
          spainCitiesLayer.setFeatureClickColumns(['wrong-column']);
        },
        provokeSourceError: function () {
          spainCitiesLayer.setSource(
            new carto.source.SQL(`
              SELECT *
              FROM mne_10m_populated_places_simple
              WHERE adm0name = \'Spain\'
            `)
          );
        }
      };

      var sourceActions = {
        provokeError: function () {
          spainCitiesSource.setQuery('SELECT * FROM meh')
            .catch(function (error) {
              logCartoError('SET QUERY', error);
            });
        }
      };

      var styleActions = {
        provokeError: function () {
          spainCitiesStyle.setContent(`
            #layer {
              marker-fill: "wrong-value;
              marker-line-color: #FFFFFF;
            }`);
        }
      };
    </script>
  </body>
</html>
